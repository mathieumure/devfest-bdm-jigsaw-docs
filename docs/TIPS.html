<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TIPS | Star Jigsaw - La guerre des modules</title>
    <meta name="description" content="Hand&#39;s on Jigsaw @ Devfest">
    
    
    <link rel="preload" href="/devfest-nantes-jigsaw-docs/assets/css/0.styles.b701df7f.css" as="style"><link rel="preload" href="/devfest-nantes-jigsaw-docs/assets/js/app.e027a18b.js" as="script"><link rel="preload" href="/devfest-nantes-jigsaw-docs/assets/js/11.5e7b5d5b.js" as="script"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/2.90a804d4.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/3.df813b19.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/4.87ba1880.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/5.eb7c0501.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/6.3610f191.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/7.68324e78.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/8.e9baf74d.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/9.993579d6.js"><link rel="prefetch" href="/devfest-nantes-jigsaw-docs/assets/js/10.6b67e639.js">
    <link rel="stylesheet" href="/devfest-nantes-jigsaw-docs/assets/css/0.styles.b701df7f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/devfest-nantes-jigsaw-docs/" class="home-link router-link-active"><!----> <span class="site-name">Star Jigsaw - La guerre des modules</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/devfest-nantes-jigsaw-docs/TIPS.html" class="nav-link router-link-exact-active router-link-active">Tips</a></div><div class="nav-item"><a href="https://github.com/mathieumure/devfest-nantes-jigsaw-webapp" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Frontend
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Zenika/draft-hands-on-jigsaw-devfest" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/devfest-nantes-jigsaw-docs/TIPS.html" class="nav-link router-link-exact-active router-link-active">Tips</a></div><div class="nav-item"><a href="https://github.com/mathieumure/devfest-nantes-jigsaw-webapp" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Frontend
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Zenika/draft-hands-on-jigsaw-devfest" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/devfest-nantes-jigsaw-docs/" class="sidebar-link">A long time ago in a galaxy far far away...</a></li><li><a href="/devfest-nantes-jigsaw-docs/EPISODE_1.html" class="sidebar-link">Episode I - La Menace de la configuration</a></li><li><a href="/devfest-nantes-jigsaw-docs/EPISODE_2.html" class="sidebar-link">Episode II - Le guerre du Hello World</a></li><li><a href="/devfest-nantes-jigsaw-docs/EPISODE_3.html" class="sidebar-link">Episode III - La revanche des Sith Maven</a></li><li><a href="/devfest-nantes-jigsaw-docs/EPISODE_4.html" class="sidebar-link">Episode IV - Gradle, un Nouvel Espoir</a></li><li><a href="/devfest-nantes-jigsaw-docs/EPISODE_5.html" class="sidebar-link">Episode V - Yoda contre-attaque</a></li><li><a href="/devfest-nantes-jigsaw-docs/TIPS.html" class="active sidebar-link">TIPS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devfest-nantes-jigsaw-docs/TIPS.html#fichier-module-info-java" class="sidebar-link">Fichier module-info.java</a></li><li class="sidebar-sub-header"><a href="/devfest-nantes-jigsaw-docs/TIPS.html#javac-et-les-modules" class="sidebar-link">javac et les modules</a></li><li class="sidebar-sub-header"><a href="/devfest-nantes-jigsaw-docs/TIPS.html#java-et-les-modules" class="sidebar-link">java et les modules</a></li><li class="sidebar-sub-header"><a href="/devfest-nantes-jigsaw-docs/TIPS.html#gradle" class="sidebar-link">Gradle</a></li><li class="sidebar-sub-header"><a href="/devfest-nantes-jigsaw-docs/TIPS.html#idea-et-les-modules" class="sidebar-link">IDEA et les modules</a></li><li class="sidebar-sub-header"><a href="/devfest-nantes-jigsaw-docs/TIPS.html#generation-de-modules-linkes-et-jre-optimise" class="sidebar-link">Génération de modules &quot;linkés&quot; et JRE optimisé</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="tips"><a href="#tips" aria-hidden="true" class="header-anchor">#</a> TIPS</h1> <p>Une question, un doute sur votre pouvoir de modularisation? Vous trouverez tout ce qu'il vous faut ici!</p> <h2 id="fichier-module-info-java"><a href="#fichier-module-info-java" aria-hidden="true" class="header-anchor">#</a> Fichier module-info.java</h2> <p>Ce fichier permet de décrire un module, il doit être présent à la racine des sources du module (ici dans src/main/java).
En &quot;standard&quot; l'arborescence des projets avec plusieurs modules diffère de celle que l'on retrouve classiquement :</p> <p><a href="http://openjdk.java.net/projects/jigsaw/quick-start" target="_blank" rel="noopener noreferrer">Exemple d'Oracle<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> pour les modules <code>org.astro</code> et <code>com.greetings</code></p> <div class="language- extra-class"><pre class="language-text"><code>    src/org.astro/module-info.java
    src/org.astro/org/astro/World.java
    src/com.greetings/com/greetings/Main.java
    src/com.greetings/module-info.java
</code></pre></div><p>Mais il reste possible d'avoir une arborescence plus classique (ce qui sera fait ici) :</p> <div class="language- extra-class"><pre class="language-text"><code>org.astro
    src/java/module-info.java
    src/java/org/astro/World.java
com.greetings
    src/java/com/greetings/Main.java
    src/java/module-info.java
</code></pre></div><p>Si votre module se nomme <code>nom.de.mon.module</code>, on retrouve ce nom dans la déclaration du module</p> <div class="language-java extra-class"><pre class="language-java"><code>module nom<span class="token punctuation">.</span>de<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>module <span class="token punctuation">{</span>
    <span class="token comment">// instructions</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>TIPS</strong>
Pour éviter les collisions dans les noms de modules, une pratique est de mettre des noms de modules identiques aux noms de package que l'on expose.</p> <p>Un module peut contenir des instructions pour :</p> <ul><li>Exposer les éléments publics d'un package : <strong>exports</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code>exports nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span>
</code></pre></div><ul><li>Permettre d'utiliser le module via de la reflexivité : <strong>opens</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code>opens nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span>
</code></pre></div><p><strong>Attention :</strong> Cela permet aussi d'&quot;ouvrir&quot; à d'autres modules les ressources du package (des fichiers par exemple)</p> <ul><li>Permettre à un module d'utiliser un autre module : <strong>requires</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code>requires nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span>module
</code></pre></div><ul><li>Préciser que l'on fournit l'implementation d'une interface (pour pouvoir l'utiliser avec le ServiceLoader) : <strong>provides</strong> _ <strong>with</strong> _</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>provides une<span class="token punctuation">.</span><span class="token keyword">interface</span>
              <span class="token class-name">with</span> une<span class="token punctuation">.</span>implementation
</code></pre></div><ul><li>Pouvoir utiliser (grace au ServiceLoader) les implémentations d'une interface qui ont été définies via <em>provides * with *</em> : <strong>uses</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code>uses une<span class="token punctuation">.</span><span class="token keyword">interface</span>
</code></pre></div><p><strong>Attention:</strong> ces instructions n'incluent pas les sous-packages (si vous faites un export sur le package <code>a.b</code> le package <code>a.b.c</code> ne sera pas publique pour autant)</p> <p>En résumé :</p> <div class="language-java extra-class"><pre class="language-java"><code>module nom<span class="token punctuation">.</span>de<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>module <span class="token punctuation">{</span>
    exports nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token punctuation">.</span>aa<span class="token punctuation">;</span> <span class="token comment">// rend accessible les objets publiques nom.du.package.aa du package</span>
    exports nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token punctuation">.</span>bb<span class="token punctuation">;</span> <span class="token comment">// rend accessible les objets publiques nom.du.package.bb du package</span>

    opens nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token punctuation">.</span>aa<span class="token punctuation">;</span> <span class="token comment">// ouvre à la reflexivité le package nom.du.package.aa, cela permet aussi d'accéder aux ressources du package</span>

    requires nom<span class="token punctuation">.</span>dun<span class="token punctuation">.</span>autre<span class="token punctuation">.</span>module<span class="token punctuation">;</span> <span class="token comment">// permet d'utiliser les objets publiques du module nom.dun.autre.module</span>
    requires nom<span class="token punctuation">.</span>dun<span class="token punctuation">.</span>second<span class="token punctuation">.</span>module<span class="token punctuation">;</span> <span class="token comment">// permet d'utiliser les objets publiques du module nom.dun.second.module</span>

    provides nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token punctuation">.</span>aa<span class="token punctuation">.</span>InterfaceFoo with nom<span class="token punctuation">.</span>du<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token punctuation">.</span>cc<span class="token punctuation">.</span>FooImpl<span class="token punctuation">;</span> <span class="token comment">// fournit l'implémentation nom.du.package.cc.FooImpl de l'interface nom.du.package.aa.InterfaceFoo pour le ServiceLoader</span>

    uses nom<span class="token punctuation">.</span>dun<span class="token punctuation">.</span>autre<span class="token punctuation">.</span>module<span class="token punctuation">.</span>InterfaceBar<span class="token punctuation">;</span> <span class="token comment">// Permettra au ServiceLoader de récupérer les implémentations &quot;provided&quot; de l'interface nom.dun.autre.module.InterfaceBar présentes au runtime dans le module-path</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="pour-aller-plus-loin"><a href="#pour-aller-plus-loin" aria-hidden="true" class="header-anchor">#</a> Pour aller plus loin</h3> <p>La gestion des dépendances peut être affinée :</p> <ul><li><strong>requires transitive</strong> <em>ZZZ</em> : permet de spécifier dans le module la dépendances <em>ZZZ</em> qui sera récupéré par transitivité pour les utilisateurs de ce module</li> <li><strong>requires static</strong> <em>mysql.jdbc</em>: permet de gérer les dépendances optionnelles au runtime mais nécessaires à la compilation (ex : une appli qui peut utiliser une base oracle ou mysql ou … on mets un requires static sur les drivers spécifiques)</li></ul> <p>La portée de ce qui est exposé peut être limitée à des modules spécifiques :</p> <ul><li><strong>exports</strong> <em>process</em> <strong>to</strong> <em>dev.random</em> : expose les méthodes publiques du package <em>process</em> (avec une portée limitée au module <em>dev.random</em>)</li></ul> <p>Le module peut être complètement ouvert (<em>a great power comes with great responsability</em>)</p> <ul><li><strong>open</strong> <em>module nom.de.mon.module</em> <strong>{}</strong></li></ul> <p>Le JDK étant lui même modulaire, pour connaitre la liste des modules et leurs dépendances :</p> <ul><li>La <a href="https://docs.oracle.com/javase/9/docs/api/overview-summary.html" target="_blank" rel="noopener noreferrer">javadoc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (en htm5, avec un search, la révolution...)</li> <li>Le <a href="http://cr.openjdk.java.net/~mr/jigsaw/jdk9-module-summary.html" target="_blank" rel="noopener noreferrer">JDK Module Summary<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>De nouvelles options et programmes dans la CLI du JDK</li></ul> <div class="language- extra-class"><pre class="language-text"><code>java -p api-marvel/build/libs/api-marvel.jar --describe-module org.znk.handson.jigsaw.api
jar --file=api-marvel/build/libs/api-marvel.jar --describe-module
jdeps --module-path ./api-marvel/build/libs/api-marvel.jar -recursive ./marvel-local-impl/build/libs/marvel-local-impl.jar
...
</code></pre></div><h2 id="javac-et-les-modules"><a href="#javac-et-les-modules" aria-hidden="true" class="header-anchor">#</a> <a href="https://docs.oracle.com/javase/9/tools/javac.htm#JSWOR627" target="_blank" rel="noopener noreferrer">javac<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> et les modules</h2> <p>Quand vous construisez un module il est nécessaire de lui spécifier le chemin des modules <strong>requires</strong> qui ne sont pas fournis par le JDK (ceux packagés avec votre JDK sont par défaut accessibles).</p> <div class="language-sh extra-class"><pre class="language-text"><code>javac ... --module-path PATH ...
# équivaut à
javac ... -p PATH ...
</code></pre></div><p>Avec <strong>PATH</strong> qui est la listes des modules (sous formes de JAR, mais peut aussi être des classes et des répertoires; utilise le séparateur du système). Pour retenir : <strong>les classes sont dans le classpath, les modules sont dans le modulepath</strong>.</p> <p>Astuces :</p> <ul><li>dans le cas de jar legacy il est possible de combiner classpath (legacy) et modulepath</li> <li>dans le cas de multimodules avec des dépendances, on peut utiliser la notion de module-source-path</li> <li>dans le cas de tests unitaire, les dépendances et les droits d'accès peuvent être ajoutés sans modifier le fichier module-info.java</li></ul> <div class="language-sh extra-class"><pre class="language-text"><code># avec junit (4 et 5)
javac ... --add-modules junit --add-reads nom.de.mon.module=junit ...
</code></pre></div><ul><li>et le patch d'un module pour lui ajouter les classes de tests (car les packages sont scélés)</li></ul> <div class="language-sh extra-class"><pre class="language-text"><code>javac ... --patch-module nom.de.mon.module=src/test/java... ...
</code></pre></div><h2 id="java-et-les-modules"><a href="#java-et-les-modules" aria-hidden="true" class="header-anchor">#</a> <a href="https://docs.oracle.com/javase/9/tools/java.htm#JSWOR624" target="_blank" rel="noopener noreferrer">java<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> et les modules</h2> <p>Même idée que pour javac <strong>les classes sont dans le classpath, les modules sont dans le modulepath</strong>, pour lancer le <code>main</code> de la classe <code>ma.MainClass</code> du module <code>nom.de.mon.module</code> :</p> <div class="language-sh extra-class"><pre class="language-text"><code>java ... --module-path PATH --module nom.de.mon.module/ma.MainClass ...
# équivaut à
java ... -p PATH -m nom.de.mon.module/ma.MainClass ...
</code></pre></div><p>Avec <strong>PATH</strong> qui est la liste des modules (sous formes de JAR, mais peut aussi être des classes et des répertoires; utilise le séparateur du système</p> <p>Pour les tests unitaires il faut, là aussi, modifier les droits et dépendances pour que nos librairies de tests puissent accéder à notre module et que notre classe de tests puisse les utiliser.</p> <div class="language-sh extra-class"><pre class="language-text"><code># avec junit 4.12 &amp; hamcrest
java ...  --module-path PATH
          --add-modules junit \
          --add-reads nom.de.mon.module=junit \
          --add-reads nom.de.mon.module=hamcrest.core \
          --add-exports nom.de.mon.module/nom.du.package=junit \
          --add-exports nom.de.mon.module/nom.du.package=hamcrest.core \
          --patch-module nom.de.mon.module=src/test/java... \
          ...
</code></pre></div><ul><li><strong>--add-reads</strong> : permet au runtime de rendre accessible au module <em>nom.de.mon.module</em> un module qui n'est pas <em>required</em> (ici <em>junit</em>)</li> <li><strong>--add-exports</strong> : permet au runtime de rendre exportable le package <em>nom.du.package</em> du module <em>nom.de.mon.module</em> à un autre module qui n'y aurait normalement pas accès (ici <em>junit</em>)</li> <li><strong>--add-opens</strong> : idem que <strong>--add-exports</strong> mais ouverture complète à la reflexivité (inutile dans notre cas puisque la réflexivité est réalisée via de l'indirection depuis le même module)</li> <li><strong>--patch-module</strong> : permet de patcher un module en lui ajoutant des classes non présentes initialement (permet d'avoir pour les tests unitaire des noms de package identique à ce qui est testé ce qui n'est pas autorisé par défaut)</li></ul> <h2 id="gradle"><a href="#gradle" aria-hidden="true" class="header-anchor">#</a> Gradle</h2> <p>Un wrapper de Gradle est directement disponible dans le projet en version 4.6. Pour le lancer depuis la racine du projet</p> <div class="language- extra-class"><pre class="language-text"><code>./gradlew

&gt; Task :help

Welcome to Gradle 4.6.

To run a build, run gradlew &lt;task&gt; ...

To see a list of available tasks, run gradlew tasks
...
...
</code></pre></div><p>Le premier lancement va être un peu plus long car il va télécharger la distribution de gradle.</p> <p>La liste des principales <code>tasks</code> utiles au projet</p> <ul><li><code>check</code> (ou <code>test</code>) : lance les tests unitaires (les tests ne sont pas exécutés si le code n'a pas changé)</li> <li><code>compileJava</code> : lance la compilation des classes java (seul le code qui change est compilé)</li> <li><code>build</code> : lance la compilation et les tests unitaires</li> <li><code>run</code> : lance la main classe (pour les applications seulement). Cette commande ne termine &quot;jamais&quot; et reste à un état d'avancement de 95%</li> <li><code>jar</code> : package le projet, les modules sous forme de jar</li> <li><code>clean</code> : efface le resultat du build, permet par exemple de forcer l'execution des tests s'il n'y a pas eu de modification de code</li> <li><code>installDist</code> : <em>optionnel</em> génère une distribution du projet avec son script de lancement, ses librairies et ses dépendances</li></ul> <p>Autre commandes utiles à gradle ;</p> <ul><li><code>--status</code> : affiche le status des daemons gradle</li> <li><code>--stop</code> : arrête les daemons gradle</li></ul> <p>Gradle fonctionne en mode classpath, cependant il est possible (et c'est ce pourquoi vous êtes ici) de changer cela.
2 approches sont possibles :</p> <ul><li>Utiliser le plugin chainsaw (il existe un plugin officiel expérimental mais il est moins avancé)</li> <li>Surcharger les taks spécifiques de compilation, execution et tests</li></ul> <h3 id="utiliser-le-plugin-chainsaw"><a href="#utiliser-le-plugin-chainsaw" aria-hidden="true" class="header-anchor">#</a> Utiliser le plugin chainsaw</h3> <p>Il suffit d'ajouter dans les plugins du(/des) projet(s), le plugin com.zyxist.chainsaw</p> <div class="language-diff extra-class"><pre class="language-diff"><code>plugins {
    id 'java-library'
<span class="token inserted">+   id 'com.zyxist.chainsaw' version '0.3.1'</span>
}
</code></pre></div><p><strong>Attention</strong> avec JUnit 5 il faut ouvrir les packages que l'on teste au module <code>org.junit.platform.commons</code></p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>javaModule<span class="token operator">.</span>hacks <span class="token punctuation">{</span>
    <span class="token function">exports</span><span class="token punctuation">(</span><span class="token string">'&lt;NOM_DU_MODULE&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;PACKAGE_A_EXPOSER&gt;'</span><span class="token punctuation">,</span> <span class="token string">'org.junit.platform.commons'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="utiliser-la-configuration-gradle"><a href="#utiliser-la-configuration-gradle" aria-hidden="true" class="header-anchor">#</a> Utiliser la configuration gradle</h3> <h4 id="definir-dans-la-variable-le-nom-du-module"><a href="#definir-dans-la-variable-le-nom-du-module" aria-hidden="true" class="header-anchor">#</a> Définir dans la variable le nom du module</h4> <p>La variable <code>moduleName</code> sera utilisée par la suite (notamment dans les tests)</p> <div class="language-diff extra-class"><pre class="language-diff"><code>plugins {
    id 'java-library'
}

<span class="token inserted">+ ext.moduleName = &quot;org.zenika.handson.jigsaw.api&quot;</span>
</code></pre></div><h4 id="surcharger-les-options-de-compilation"><a href="#surcharger-les-options-de-compilation" aria-hidden="true" class="header-anchor">#</a> Surcharger les options de compilation</h4> <p>Dans votre build.gradle afin d'avoir un <code>modulepath</code> alimenté à partir de ce qui irait normalement dans le <code>classpath</code></p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>    compileJava <span class="token punctuation">{</span>
        doFirst <span class="token punctuation">{</span>
            options<span class="token operator">.</span>compilerArgs <span class="token operator">=</span> <span class="token punctuation">[</span>
                    <span class="token string">'--module-path'</span><span class="token punctuation">,</span> classpath<span class="token operator">.</span>asPath<span class="token punctuation">,</span> <span class="token comment">// alimente le modulepath via le classpath</span>
            <span class="token punctuation">]</span>
            classpath <span class="token operator">=</span> <span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// vide le classpath</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="surcharger-les-options-de-compilation-des-tests"><a href="#surcharger-les-options-de-compilation-des-tests" aria-hidden="true" class="header-anchor">#</a> Surcharger les options de compilation des tests</h4> <p>Pour les tests en plus du modulepath il faut :</p> <ul><li>Modifier le graph de dépendance pour y ajouter le module junit</li> <li>Modifier le graph de dépendance pour que le module puisse utiliser junit (équivaut à un <code>requires</code>)</li> <li>Patcher le module pour forcer l'inclusion des classes de tests dans le package (les packages sont scellés, les tests étant dans un autre répertoire mais dans le même package, les mécanismes de protection de Jigsaw s'activent)</li></ul> <div class="language-groovy extra-class"><pre class="language-groovy"><code>    compileTestJava <span class="token punctuation">{</span>
        inputs<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string gstring">&quot;moduleName&quot;</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span> <span class="token comment">// la variable moduleName doit être déclarée dans chaque build.gradle des modules</span>
        doFirst <span class="token punctuation">{</span>
            options<span class="token operator">.</span>compilerArgs <span class="token operator">=</span> <span class="token punctuation">[</span>
                    <span class="token string">'--module-path'</span><span class="token punctuation">,</span> classpath<span class="token operator">.</span>asPath<span class="token punctuation">,</span>
                    <span class="token string">'--add-modules'</span><span class="token punctuation">,</span> <span class="token string">'org.junit.jupiter.api'</span><span class="token punctuation">,</span> <span class="token comment">// junit fait maintenant partie du graphe des modules alors qu'il n'a pas de dépendance transitive</span>
                    <span class="token string">'--add-reads'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=org.junit.jupiter.api&quot;</span><span class="token punctuation">,</span> <span class="token comment">// equivaut à faire dans le module un requires org.junit.jupiter.api</span>
                    <span class="token string">'--add-reads'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=org.junit.platform.commons&quot;</span><span class="token punctuation">,</span> <span class="token comment">// idem ...</span>
                    <span class="token string">'--patch-module'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=&quot;</span> <span class="token operator">+</span> <span class="token function">files</span><span class="token punctuation">(</span>sourceSets<span class="token operator">.</span>test<span class="token operator">.</span>java<span class="token operator">.</span>srcDirs<span class="token punctuation">)</span><span class="token operator">.</span>asPath<span class="token punctuation">,</span> <span class="token comment">// patch le module</span>
            <span class="token punctuation">]</span>
            classpath <span class="token operator">=</span> <span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="surcharger-les-options-d-execution"><a href="#surcharger-les-options-d-execution" aria-hidden="true" class="header-anchor">#</a> Surcharger les options d'exécution</h4> <p>Il faut en plus :</p> <ul><li>Spécifier la main classe qui sera lancée (via un --module)</li></ul> <blockquote><p>Cette configuration s'applique au plugin <code>application</code></p></blockquote> <div class="language-groovy extra-class"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'application'</span>
<span class="token punctuation">}</span>
<span class="token punctuation">...</span>
mainClassName <span class="token operator">=</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>/org.zenika.handson.jigsaw.http.Application&quot;</span>

run <span class="token punctuation">{</span>
    inputs<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string gstring">&quot;moduleName&quot;</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span>
    doFirst <span class="token punctuation">{</span>
        jvmArgs <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string">'--module-path'</span><span class="token punctuation">,</span> classpath<span class="token operator">.</span>asPath<span class="token punctuation">,</span>
                <span class="token string">'--module'</span><span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> <span class="token comment">// utiliser l'option module pour lancer la &quot;main class&quot;</span>
        <span class="token punctuation">]</span>
        classpath <span class="token operator">=</span> <span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        copy <span class="token punctuation">{</span>
            <span class="token comment">// Les ressources étant encore dans un répertoire différent, elles ne sont pas accessibles avec l'isolation de Jigsaw =&gt; il faut donc les copier dans le répertoire contenant les classes</span>
            from <span class="token string">'src/main/resources'</span>
            into <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>buildDir</span>/classes/java/main/&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="surcharger-les-options-d-execution-des-tests"><a href="#surcharger-les-options-d-execution-des-tests" aria-hidden="true" class="header-anchor">#</a> Surcharger les options d'exécution des tests</h4> <p>Il faut en plus :</p> <ul><li><code>add-export</code> pour exposer à junit les packages qui seront testés</li> <li><code>add-modules ALL-MODULE-PATH</code> pour ajouter dans le graphe de résolution tous les modules (et auto modules) qui sont dans le module-path</li></ul> <div class="language-groovy extra-class"><pre class="language-groovy"><code>test <span class="token punctuation">{</span>
    inputs<span class="token operator">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string gstring">&quot;moduleName&quot;</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span>
<span class="token punctuation">...</span>
    doFirst <span class="token punctuation">{</span>
        <span class="token comment">// Hack Les ressources étant encore dans un répertoire différent elles ne sont pas accessibles avec l'isolation de Jigsaw =&gt; il faut donc les copier dans le répertoire contenant les classes</span>
        copy <span class="token punctuation">{</span>
            from <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>projectDir</span>/src/main/resources&quot;</span>
            into <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>buildDir</span>/classes/java/main/&quot;</span>
        <span class="token punctuation">}</span>

        jvmArgs <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token comment">//'--show-module-resolution', // le pouvoir de vision peut vous sauver la vie</span>
                <span class="token string">'--module-path'</span><span class="token punctuation">,</span> classpath<span class="token operator">.</span>asPath<span class="token punctuation">,</span>
                <span class="token string">'--add-modules'</span><span class="token punctuation">,</span> <span class="token string">'ALL-MODULE-PATH'</span><span class="token punctuation">,</span>
                <span class="token string">'--add-reads'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=org.junit.jupiter.api&quot;</span><span class="token punctuation">,</span>
                <span class="token string">'--add-reads'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=org.junit.platform.commons&quot;</span><span class="token punctuation">,</span>
                <span class="token string">'--add-reads'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=feign.core&quot;</span><span class="token punctuation">,</span>
                <span class="token string">'--add-reads'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=feign.gson&quot;</span><span class="token punctuation">,</span>
                <span class="token string">'--add-exports'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>/<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=org.junit.jupiter.api&quot;</span><span class="token punctuation">,</span>
                <span class="token string">'--add-exports'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>/<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=org.junit.platform.commons&quot;</span><span class="token punctuation">,</span>
                <span class="token string">'--patch-module'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>moduleName</span>=&quot;</span> <span class="token operator">+</span> <span class="token function">files</span><span class="token punctuation">(</span>sourceSets<span class="token operator">.</span>test<span class="token operator">.</span>java<span class="token operator">.</span>outputDir<span class="token punctuation">)</span><span class="token operator">.</span>asPath<span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        classpath <span class="token operator">=</span> <span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="idea-et-les-modules"><a href="#idea-et-les-modules" aria-hidden="true" class="header-anchor">#</a> IDEA et les modules</h2> <p>La prise en charge des modules ne se limite pas à gérer la phase de compilation. Il faut aussi le prendre en compte en phase d'exécution.</p> <p>IDEA gère cela pour les applications, pour les tests l'IDE utilise encore le classpath (ce qui évite d'avoir à gérer les patchs, add-export et autres joies des tests unitaires avec les modules).</p> <p>IDJ ne prend pas en compte tous les cas complexes que l'on peut rencontrer avec les ressources et les modules :</p> <ul><li>Dans un livrable packagé (ex: un jar), les ressources sont dans la même arborescence que les classes, les classes peuvent donc accéder aux ressources sans faire face aux restrictions d'accès des modules</li> <li>En phase de développement les ressources et les classes compilées sont dans des arborescences différentes, à l'exécution ces arborescences sont passées en arguments de <code>java</code>. Les classes étant positionnées ailleurs elles n'ont pas accès aux ressources.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>java ... .../marvel-http-server/out/production/classes:.../marvel-http-server/out/production/resources:.../devoxx-exo/marvel-local-impl/out/production/classes:.../marvel-local-impl/out/production/resources:... -m org.zenika.handson.jigsaw.http/org.zenika.handson.jigsaw.http.Application
</code></pre></div><p>Dans notre application les ressources sont incluses dans le code et donc accédées via le classloader ce qui ne marche pas dans le cas présent. Il est cependant possible de contourner cela, en choisissant pour les modules qui ont ce besoin (<code>org.zenika.handson.jigsaw.api.local.impl</code> et <code>org.zenika.handson.jigsaw.http</code>), d'utiliser dans IDJ une arborescente en developpement spécifique au runtime (File/Project Structure/Project Settings/Module...<strong>Use module compile output path</strong> voir copie d'écran)</p> <p><img src="/devfest-nantes-jigsaw-docs/assets/img/idea_module_tips.29684df1.png" alt></p> <h2 id="generation-de-modules-linkes-et-jre-optimise"><a href="#generation-de-modules-linkes-et-jre-optimise" aria-hidden="true" class="header-anchor">#</a> Génération de modules &quot;linkés&quot; et JRE optimisé</h2> <p>Ces fonctions avancées permettent d’avoir une application packagée avec une JVM allégée ainsi qu’un graphe des dépendances déjà calculé et contrôlé pour optimiser le temps de démarrage.</p> <p><strong>Attention</strong> cette fonctionnalité est limitée aux modules (on ne peut pas inclure de jar legacy ou d'auto-modules pour générer un JRE optimisé)</p> <div class="language-sh extra-class"><pre class="language-text"><code># generation des jar
./gradlew jar

# generation de la JVM packagée avec nos modules et ses dépendances
jlink \
--module-path $JAVA_HOME/jmods:`pwd`/api-marvel/build/libs/api-marvel.jar:...liste_des_binaires_modules_ou_repertoire....   \
--add-modules org.zenika.handson.jigsaw.api.local.impl,...liste_des_noms_des_modules...\
--output `pwd`/marveljre --launcher marvelous=org.zenika.handson.jigsaw.http/org.zenika.handson.jigsaw.http.Application \
--compress=2

# affichage des modules de notre JRE optimisé
./marveljre/bin/java --list-modules
</code></pre></div><p>La liste des modules de notre JRE &quot;light&quot; est</p> <ul><li>java.base@9.0.4</li> <li>java.logging@9.0.4</li> <li>jdk.httpserver@9.0.4</li> <li>me.xdrop.diffutils</li> <li>me.xdrop.fuzzywuzzy</li> <li>org.zenika.handson.jigsaw.api</li> <li>org.zenika.handson.jigsaw.api.local.impl</li> <li>org.zenika.handson.jigsaw.http open</li></ul> <p>La version @9.0.4 est celle de la JVM &quot;source&quot;. Si l'on voulait avoir un numéro de version il faut générer le jar avec l'option <em>--module-version</em> (mais cette information n'est malheureusement pas exploitée pour gérer les versions des modules)</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/devfest-nantes-jigsaw-docs/EPISODE_5.html" class="prev">
          Episode V - Yoda contre-attaque
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/devfest-nantes-jigsaw-docs/assets/js/11.5e7b5d5b.js" defer></script><script src="/devfest-nantes-jigsaw-docs/assets/js/app.e027a18b.js" defer></script>
  </body>
</html>
